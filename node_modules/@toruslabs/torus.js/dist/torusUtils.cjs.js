module.exports=function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=15)}([function(e,t){e.exports=require("bn.js")},function(e,t){e.exports=require("@babel/runtime/regenerator")},function(e,t){e.exports=require("@toruslabs/http-helpers")},function(e,t){e.exports=require("web3-utils")},function(e,t){e.exports=require("@babel/runtime/helpers/asyncToGenerator")},function(e,t){e.exports=require("@toruslabs/eccrypto")},function(e,t){e.exports=require("@babel/runtime/helpers/defineProperty")},function(e,t){e.exports=require("@babel/runtime/helpers/toConsumableArray")},function(e,t){e.exports=require("@babel/runtime/helpers/typeof")},function(e,t){e.exports=require("@babel/runtime/helpers/classCallCheck")},function(e,t){e.exports=require("@babel/runtime/helpers/createClass")},function(e,t){e.exports=require("elliptic")},function(e,t){e.exports=require("memory-cache")},function(e,t){e.exports=require("loglevel")},function(e,t){e.exports=require("json-stable-stringify")},function(e,t,r){"use strict";r.r(t);var n=r(1),o=r.n(n),u=r(6),a=r.n(u),i=r(8),c=r.n(i),s=r(4),l=r.n(s),f=r(9),p=r.n(f),h=r(10),b=r.n(h),d=r(5),g=r(2),v=r(0),m=r.n(v),y=r(11),k=r(12),x=r.n(k),O=r(3),w=r(13),j=r.n(w).a.getLogger("torus.js"),P=function(e,t){return new Promise((function(r,n){var o,u=0,a={resolved:!1},i=new Array(e.length).fill(void 0),c=new Array(e.length).fill(void 0);e.forEach((function(s,l){s.then((function(e){c[l]=e})).catch((function(e){i[l]=e})).finally((function(){a.resolved||t(c.slice(0),a).then((function(e){a.resolved=!0,r(e)})).catch((function(e){o=e})).finally((function(t){(u+=1)===e.length&&n(new Error("Unable to resolve enough promises, errors: ".concat(JSON.stringify(i),", responses: ").concat(JSON.stringify(c),", predicate: ").concat(o.message||o)))}))}))}))}))},S=r(7),_=r.n(S),A=r(14),q=r.n(A);function K(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function C(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?K(Object(r),!0).forEach((function(t){a()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):K(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var E=function e(t,r){var n=t;if("number"==typeof n&&(n=Array.from({length:n},(function(e,t){return t}))),r>n.length||r<=0)return[];if(r===n.length)return[n];if(1===r)return n.reduce((function(e,t){return[].concat(_()(e),[[t]])}),[]);for(var o=[],u=[],a=0;a<=n.length-r+1;a+=1){u=e(n.slice(a+1),r-1);for(var i=0;i<u.length;i+=1)o.push([n[a]].concat(_()(u[i])))}return o},M=function(e,t){for(var r={},n=0;n<e.length;n+=1){var o=q()(e[n]);if(r[o]=r[o]?r[o]+1:1,r[o]===t)return e[n]}},R=function(e,t,r){var n=e.map((function(e){return Object(g.post)(e,Object(g.generateJsonRPCObject)("VerifierLookupRequest",{verifier:t,verifier_id:r.toString()})).catch((function(e){}))}));return P(n,(function(t){var r=t.filter((function(e){return e})),n=M(r.map((function(e){return e&&e.error})),1+~~(e.length/2)),o=M(r.map((function(e){return e&&e.result})),1+~~(e.length/2));return o||n?Promise.resolve({keyResult:o,errorResult:n}):Promise.reject(new Error("invalid"))})).catch((function(e){}))},D=function e(t,r,n,o,u,a){var i,c;if(void 0===n?(i=Math.floor(Math.random()*t.length),c=i):i=n%t.length,i===o)throw new Error("Looped through all");void 0!==o&&(c=o);var s=Object(g.generateJsonRPCObject)("KeyAssign",{verifier:u,verifier_id:a.toString()});return Object(g.post)("https://signer.tor.us/api/sign",s,{headers:{pubKeyX:r[i].X,pubKeyY:r[i].Y}},{useAPIKey:!0}).then((function(n){return Object(g.post)(t[i],C(C({},s),n),{headers:{"Content-Type":"application/json; charset=utf-8"}}).catch((function(n){return e(t,r,i+1,c,u,a)}))}))};function I(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function X(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?I(Object(r),!0).forEach((function(t){a()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):I(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var Y=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.enableLogging,n=void 0!==r&&r,o=t.metadataHost,u=void 0===o?"https://metadata.tor.us":o,a=t.allowHost,i=void 0===a?"https://signer.tor.us/api/allow":a;p()(this,e),this.ec=new y.ec("secp256k1"),this.metadataHost=u,this.allowHost=i,this.metadataCache=x.a,j.setDefaultLevel("DEBUG"),n||j.disableAll(),this.metadataLock={}}var t,r,n;return b()(e,[{key:"retrieveShares",value:(n=l()(o.a.mark((function e(t,r,n,u,a){var i,s,f,p,h,b,v,y,k=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=[],e.next=3,Object(g.get)(this.allowHost,{},{useAPIKey:!0});case 3:for(s=Object(d.generatePrivate)(),f=Object(d.getPublic)(s).toString("hex"),p=f.slice(2,66),h=f.slice(66),b=Object(O.keccak256)(a),v=0;v<t.length;v+=1)y=Object(g.post)(t[v],Object(g.generateJsonRPCObject)("CommitmentRequest",{messageprefix:"mug00",tokencommitment:b.slice(2),temppubx:p,temppuby:h,verifieridentifier:n})).catch((function(e){return j.debug("commitment",e)})),i.push(y);return e.abrupt("return",P(i,(function(e){return e.filter((function(e){return!(!e||"object"!==c()(e)||e.error)})).length>=3*~~(t.length/4)+1?Promise.resolve(e):Promise.reject(new Error("invalid"))})).then((function(e){for(var i=[],c=[],f=0;f<e.length;f+=1)e[f]&&c.push(e[f].result);for(var p=0;p<t.length;p+=1){var h=Object(g.post)(t[p],Object(g.generateJsonRPCObject)("ShareRequest",{encrypted:"yes",item:[X(X({},u),{},{idtoken:a,nodesignatures:c,verifieridentifier:n})]})).catch((function(e){return j.debug("share req",e)}));i.push(h)}return P(i,function(){var e=l()(o.a.mark((function e(n,u){var a,i,c,l,f,p,h,b,g,v,y,x,O,w;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.filter((function(e){return e})),i=M(n.map((function(e){return e&&e.result&&e.result.keys[0].PublicKey})),1+~~(t.length/2)),!(a.length>=1+~~(t.length/2)&&i)){e.next=32;break}for(c=[],l=[],f=0;f<n.length;f+=1)n[f]&&n[f].result&&n[f].result.keys&&n[f].result.keys.length>0?(n[f].result.keys.sort((function(e,t){return new m.a(e.Index,16).cmp(new m.a(t.Index,16))})),n[f].result.keys[0].Metadata?(p={ephemPublicKey:Buffer.from(n[f].result.keys[0].Metadata.ephemPublicKey,"hex"),iv:Buffer.from(n[f].result.keys[0].Metadata.iv,"hex"),mac:Buffer.from(n[f].result.keys[0].Metadata.mac,"hex"),mode:Buffer.from(n[f].result.keys[0].Metadata.mode,"hex")},c.push(Object(d.decrypt)(s,X(X({},p),{},{ciphertext:Buffer.from(atob(n[f].result.keys[0].Share).padStart(64,"0"),"hex")})).catch((function(e){return j.debug("share decryption",e)})))):c.push(Promise.resolve(Buffer.from(n[f].result.keys[0].Share.padStart(64,"0"),"hex")))):c.push(Promise.resolve(void 0)),l.push(new m.a(r[f],16));return e.next=8,Promise.all(c);case 8:if(h=e.sent,!u.resolved){e.next=11;break}return e.abrupt("return",void 0);case 11:b=h.reduce((function(e,t,r){return t&&e.push({index:l[r],value:new m.a(t)}),e}),[]),g=E(b.length,1+~~(t.length/2)),y=function(e){var t=g[e],r=b.filter((function(e,r){return t.includes(r)})),n=r.map((function(e){return e.value})),o=r.map((function(e){return e.index})),u=k.lagrangeInterpolation(n,o),a=Object(d.getPublic)(Buffer.from(u.toString(16,64),"hex")).toString("hex"),c=a.slice(2,66),s=a.slice(66);if(0===new m.a(c,16).cmp(new m.a(i.X,16))&&0===new m.a(s,16).cmp(new m.a(i.Y,16)))return v=u,"break"},x=0;case 15:if(!(x<g.length)){e.next=22;break}if("break"!==y(x)){e.next=19;break}return e.abrupt("break",22);case 19:x+=1,e.next=15;break;case 22:if(void 0!==v){e.next=24;break}throw new Error("could not derive private key");case 24:return e.next=26,k.getMetadata({pub_key_X:i.X,pub_key_Y:i.Y});case 26:if(O=e.sent,!u.resolved){e.next=29;break}return e.abrupt("return",void 0);case 29:return v=v.add(O).umod(k.ec.curve.n),w=k.generateAddressFromPrivKey(v),e.abrupt("return",{ethAddress:w,privKey:v.toString("hex",64)});case 32:throw new Error("invalid");case 33:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}())})));case 10:case"end":return e.stop()}}),e,this)}))),function(e,t,r,o,u){return n.apply(this,arguments)})},{key:"getMetadata",value:(r=l()(o.a.mark((function e(t,r){var n,u,a,i,c=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,u=JSON.stringify(t),null===this.metadataLock[u]){e.next=7;break}return e.next=5,this.metadataLock[u];case 5:e.next=8;break;case 7:this.metadataLock[u]=new Promise((function(e){n=function(){c.metadataLock[u]=null,e()}}));case 8:if(null===(a=this.metadataCache.get(u))){e.next=12;break}return n&&n(),e.abrupt("return",a);case 12:return e.next=14,Object(g.post)("".concat(this.metadataHost,"/get"),t,r,{useAPIKey:!0});case 14:if((i=e.sent)&&i.message){e.next=19;break}return this.metadataCache.put(u,new m.a(0),6e4),n&&n(),e.abrupt("return",new m.a(0));case 19:return this.metadataCache.put(u,new m.a(i.message,16),6e4),e.abrupt("return",new m.a(i.message,16));case 23:return e.prev=23,e.t0=e.catch(0),j.error(e.t0),n&&n(),e.abrupt("return",new m.a(0));case 28:case"end":return e.stop()}}),e,this,[[0,23]])}))),function(e,t){return r.apply(this,arguments)})},{key:"generateMetadataParams",value:function(e,t){var r=this.ec.keyFromPrivate(t.toString("hex",64)),n={data:e,timestamp:new m.a(~~(Date.now()/1e3)).toString(16)},o=r.sign(Object(O.keccak256)(JSON.stringify(n)).slice(2));return{pub_key_X:r.getPublic().getX().toString("hex"),pub_key_Y:r.getPublic().getY().toString("hex"),set_data:n,signature:Buffer.from(o.r.toString(16,64)+o.s.toString(16,64)+new m.a(o.v).toString(16,2),"hex").toString("base64")}}},{key:"setMetadata",value:(t=l()(o.a.mark((function e(t,r){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(g.post)("".concat(this.metadataHost,"/set"),t,r,{useAPIKey:!0});case 3:return n=e.sent,e.abrupt("return",n.message);case 7:return e.prev=7,e.t0=e.catch(0),j.error(e.t0),e.abrupt("return","");case 11:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(e,r){return t.apply(this,arguments)})},{key:"lagrangeInterpolation",value:function(e,t){if(e.length!==t.length)return null;for(var r=new m.a(0),n=0;n<e.length;n+=1){for(var o=new m.a(1),u=new m.a(1),a=0;a<e.length;a+=1)if(n!==a){o=(o=o.mul(t[a].neg())).umod(this.ec.curve.n);var i=t[n].sub(t[a]);i=i.umod(this.ec.curve.n),u=u.mul(i).umod(this.ec.curve.n)}var c=o.mul(u.invm(this.ec.curve.n)).umod(this.ec.curve.n);c=c.mul(e[n]).umod(this.ec.curve.n),r=r.add(c)}return r.umod(this.ec.curve.n)}},{key:"generateAddressFromPrivKey",value:function(e){var t=this.ec.keyFromPrivate(e.toString("hex",64),"hex").getPublic().encode("hex").slice(2),r="0x".concat(Object(O.keccak256)(Buffer.from(t,"hex")).slice(26));return Object(O.toChecksumAddress)(r)}},{key:"generateAddressFromPubKey",value:function(e,t){var r=this.ec.keyFromPublic({x:e.toString("hex",64),y:t.toString("hex",64)}).getPublic().encode("hex").slice(2),n="0x".concat(Object(O.keccak256)(Buffer.from(r,"hex")).slice(26));return Object(O.toChecksumAddress)(n)}},{key:"getPublicAddress",value:function(e,t,r){var n=this,u=r.verifier,a=r.verifierId,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return R(e,u,a).then((function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=r.keyResult,o=r.errorResult;if(o&&JSON.stringify(o).includes("Verifier + VerifierID has not yet been assigned"))return D(e,t,void 0,void 0,u,a).then((function(t){return R(e,u,a)}));if(n)return{keyResult:n};throw new Error("node results do not match")})).then(l()(o.a.mark((function e(){var t,r,u,a,c,s,l,f,p=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=p.length>0&&void 0!==p[0]?p[0]:{},!(r=t.keyResult)){e.next=13;break}return u=r.keys[0],a=u.pub_key_X,c=u.pub_key_Y,e.next=5,n.getMetadata({pub_key_X:a,pub_key_Y:c});case 5:if(s=e.sent,l=n.ec.keyFromPublic({x:a.toString(16),y:c.toString(16)}).getPublic().add(n.ec.keyFromPrivate(s.toString(16)).getPublic()),a=l.getX().toString(16),c=l.getY().toString(16),f=n.generateAddressFromPubKey(l.getX(),l.getY()),i){e.next=12;break}return e.abrupt("return",f);case 12:return e.abrupt("return",{address:f,X:a,Y:c});case 13:throw new Error("node results do not match");case 14:case"end":return e.stop()}}),e)}))))}}],[{key:"setAPIKey",value:function(e){Object(g.setAPIKey)(e)}},{key:"setEmbedHost",value:function(e){Object(g.setEmbedHost)(e)}}]),e}();t.default=Y}]).default;